import { test, expect } from '@playwright/test';
import { WelcomePage } from '../../../../main/PageObjects/welcomePage';
import { VerificationPage } from '../../../../main/PageObjects/verificationPage';
import { MFACodeExtractor } from '../../../../main/Extensions/getMFA';

// Enforce 1920x1080 resolution for all tests in this file
test.use({ viewport: { width: 1920, height: 1080 } });

// Set longer timeout for this comprehensive test
test.setTimeout(180000); // 3 minutes

test.describe('Happy Flow Tests', () => {
    
    test('Complete Happy Flow - Welcome ‚Üí Verification ‚Üí MFA ‚Üí Next Page', async ({ page, context }) => {
        test.info().annotations.push({
            type: 'description',
            description: 'Complete happy flow: Welcome page ‚Üí Verification page ‚Üí MFA automation ‚Üí Next page analysis'
        });

        console.log('üéâ ===== STARTING COMPLETE HAPPY FLOW TEST =====');
        
        // Initialize page objects
        const welcomePage = new WelcomePage(page);
        const verificationPage = new VerificationPage(page);
        
        // ===== STEP 1: WELCOME PAGE =====
        console.log('\nüöÄ STEP 1: WELCOME PAGE');
        console.log('   üåê Navigating to Lili onboarding welcome page...');
        await page.goto('https://lili-onboarding-integ.lili.co/welcome');
        await page.waitForLoadState('networkidle');
        await page.waitForTimeout(2000);
        
        console.log('   üìã Testing welcome page elements...');
        
        // Test key welcome page elements
        const getStartedVisible = await welcomePage.getStartedButton.isVisible();
        const logInVisible = await welcomePage.logInButton.isVisible();
        const emailInputVisible = await welcomePage.emailInput.isVisible();
        const passwordInputVisible = await welcomePage.passwordInput.isVisible();
        const liliLogoVisible = await welcomePage.liliLogo.isVisible();
        
        console.log(`   ‚úÖ Get Started Button: ${getStartedVisible ? 'VISIBLE' : 'NOT VISIBLE'}`);
        console.log(`   ‚úÖ Log In Button: ${logInVisible ? 'VISIBLE' : 'NOT VISIBLE'}`);
        console.log(`   ‚úÖ Email Input: ${emailInputVisible ? 'VISIBLE' : 'NOT VISIBLE'}`);
        console.log(`   ‚úÖ Password Input: ${passwordInputVisible ? 'VISIBLE' : 'NOT VISIBLE'}`);
        console.log(`   ‚úÖ Lili Logo: ${liliLogoVisible ? 'VISIBLE' : 'NOT VISIBLE'}`);
        
        // Fill valid email and password
        const randomDigits = Math.floor(1000 + Math.random() * 9000);
        const validEmail = `Filler${randomDigits}@mailforspam.com`;
        console.log(`   üìß Using email: ${validEmail}`);
        
        await welcomePage.emailInput.fill(validEmail);
        await welcomePage.passwordInput.fill('Password1');
        await page.waitForTimeout(1000);
        
        // Verify button is enabled and click it
        const buttonEnabled = await welcomePage.getStartedButton.isEnabled();
        console.log(`   üîò Get Started button enabled: ${buttonEnabled ? 'YES' : 'NO'}`);
        
        if (buttonEnabled) {
            console.log('   üöÄ Clicking Get Started button...');
            await welcomePage.getStartedButton.click();
            
            // Wait for redirect to verification page
            console.log('   ‚è≥ Waiting for redirect to verification page...');
            let currentUrl = page.url();
            let attempts = 0;
            const maxAttempts = 60;
            
            while (currentUrl === 'https://lili-onboarding-integ.lili.co/welcome' && attempts < maxAttempts) {
                await page.waitForTimeout(1000);
                currentUrl = page.url();
                attempts++;
                console.log(`      Attempt ${attempts}: ${currentUrl}`);
                
                if (currentUrl !== 'https://lili-onboarding-integ.lili.co/welcome') {
                    console.log(`   üéâ SUCCESS: Redirected to verification page!`);
                    break;
                }
            }
        }
        
        // ===== STEP 2: VERIFICATION PAGE =====
        console.log('\nüîê STEP 2: VERIFICATION PAGE');
        
        const verificationUrl = page.url();
        const isVerificationPage = verificationUrl.includes('/email-verification');
        console.log(`   üìç Current URL: ${verificationUrl}`);
        console.log(`   ‚úÖ On verification page: ${isVerificationPage ? 'YES' : 'NO'}`);
        
        if (isVerificationPage) {
            console.log('   üìã Testing verification page elements...');
            
            // Test key verification page elements
            const headingVisible = await verificationPage.verificationHeading.isVisible();
            const mfaInputVisible = await verificationPage.verificationCodeInput.isVisible();
            const emailDisplayVisible = await verificationPage.emailDisplay.isVisible();
            const liliLogoVisible = await verificationPage.liliLogo.isVisible();
            
            console.log(`   ‚úÖ Verification Heading: ${headingVisible ? 'VISIBLE' : 'NOT VISIBLE'}`);
            console.log(`   ‚úÖ MFA Input: ${mfaInputVisible ? 'VISIBLE' : 'NOT VISIBLE'}`);
            console.log(`   ‚úÖ Email Display: ${emailDisplayVisible ? 'VISIBLE' : 'NOT VISIBLE'}`);
            console.log(`   ‚úÖ Lili Logo: ${liliLogoVisible ? 'VISIBLE' : 'NOT VISIBLE'}`);
            
            // Get the displayed email
            const emailDisplayText = await verificationPage.emailDisplay.textContent();
            console.log(`   üìß Email displayed: ${emailDisplayText}`);
            
            // ===== STEP 3: MFA AUTOMATION =====
            console.log('\nüîê STEP 3: MFA AUTOMATION');
            
            // Extract email prefix for MFA
            const emailMatch = emailDisplayText?.match(/Filler(\d+)@mailforspam\.com/);
            if (!emailMatch) {
                throw new Error('Could not extract email prefix from verification page');
            }
            
            const emailPrefix = `Filler${emailMatch[1]}`;
            console.log(`   üîë Email prefix for MFA: ${emailPrefix}`);
            
            // Create MFA extractor and extract code
            console.log('   üîê Starting MFA code extraction...');
            const mfaExtractor = new MFACodeExtractor(context, page);
            
            let mfaCode: string;
            try {
                mfaCode = await mfaExtractor.extractMFACode(emailPrefix);
                console.log(`   ‚úÖ MFA code extracted: ${mfaCode}`);
            } catch (error) {
                console.error(`   ‚ùå MFA extraction failed: ${error}`);
                throw error;
            }
            
            // Verify we're still on verification page
            const currentVerificationUrl = page.url();
            if (!currentVerificationUrl.includes('/email-verification')) {
                throw new Error('Lost verification page during MFA extraction');
            }
            
            console.log('   ‚úÖ Still on verification page after MFA extraction');
            
            // ===== STEP 4: ENTER MFA CODE =====
            console.log('\nüî¢ STEP 4: ENTER MFA CODE');
            
            console.log(`   üî¢ Entering MFA code: ${mfaCode}`);
            await verificationPage.verificationCodeInput.fill(mfaCode);
            
            // Verify code was entered
            const enteredCode = await verificationPage.verificationCodeInput.inputValue();
            console.log(`   üìù Entered code: ${enteredCode}`);
            
            expect(enteredCode).toBe(mfaCode);
            console.log('   ‚úÖ MFA code entered successfully!');
            
            // ===== STEP 5: WAIT FOR NEXT PAGE =====
            console.log('\n‚è≥ STEP 5: WAIT FOR NEXT PAGE');
            
            console.log('   ‚è≥ Waiting 5 seconds for next page to load...');
            await page.waitForTimeout(5000);
            
            // ===== STEP 6: ANALYZE NEXT PAGE =====
            console.log('\nüéØ STEP 6: ANALYZE NEXT PAGE');
            
            const nextPageUrl = page.url();
            const nextPageTitle = await page.title();
            
            console.log(`   üìç Current URL: ${nextPageUrl}`);
            console.log(`   üìù Page Title: ${nextPageTitle}`);
            
            // Check if we're still on verification page or moved to next page
            if (nextPageUrl.includes('/email-verification')) {
                console.log('   ‚ö†Ô∏è Still on verification page - checking for changes...');
                
                // Look for any new elements or changes
                const pageContent = await page.content();
                console.log(`   üìÑ Page content length: ${pageContent.length}`);
                
                // Check for common next page indicators
                if (pageContent.includes('phone') || pageContent.includes('Phone')) {
                    console.log('   üì± Next page appears to be Phone Number page');
                } else if (pageContent.includes('identity') || pageContent.includes('Identity')) {
                    console.log('   üÜî Next page appears to be Identity page');
                } else if (pageContent.includes('address') || pageContent.includes('Address')) {
                    console.log('   üè† Next page appears to be Address page');
                } else {
                    console.log('   üîç Analyzing page content for next step indicators...');
                    
                    // Look for any headings or text that might indicate the next step
                    const headings = await page.locator('h1, h2, h3, h4, h5, h6').allTextContents();
                    if (headings.length > 0) {
                        console.log('   üìã Page headings found:');
                        headings.forEach((heading, index) => {
                            console.log(`      ${index + 1}. ${heading}`);
                        });
                    }
                }
            } else {
                console.log('   ‚úÖ Successfully moved to next page!');
                console.log(`   üéØ New page: ${nextPageUrl}`);
                
                // Analyze the new page
                const pageContent = await page.content();
                console.log(`   üìÑ New page content length: ${pageContent.length}`);
                
                // Look for key elements on the new page
                const newPageHeadings = await page.locator('h1, h2, h3, h4, h5, h6').allTextContents();
                if (newPageHeadings.length > 0) {
                    console.log('   üìã New page headings:');
                    newPageHeadings.forEach((heading, index) => {
                        console.log(`      ${index + 1}. ${heading}`);
                    });
                }
                
                // Try to identify the page type
                if (nextPageUrl.includes('/personal-details')) {
                    console.log('   üéØ PAGE IDENTIFIED: Personal Details Page');
                } else if (nextPageUrl.includes('/phone')) {
                    console.log('   üéØ PAGE IDENTIFIED: Phone Number Page');
                } else if (nextPageUrl.includes('/identity')) {
                    console.log('   üéØ PAGE IDENTIFIED: Identity Verification Page');
                } else if (nextPageUrl.includes('/address')) {
                    console.log('   üéØ PAGE IDENTIFIED: Address Page');
                } else {
                    console.log('   üîç PAGE TYPE: Unknown - analyzing content...');
                }
            }
            
            // ===== FINAL RESULTS =====
            console.log('\nüéâ ===== HAPPY FLOW COMPLETED =====');
            console.log(`   üìß Email Used: ${validEmail}`);
            console.log(`   üîê MFA Code: ${mfaCode}`);
            console.log(`   üåê Final URL: ${nextPageUrl}`);
            console.log(`   üìù Final Page Title: ${nextPageTitle}`);
            console.log('   ‚úÖ Happy flow test completed successfully!');
            
        } else {
            throw new Error('Failed to reach verification page');
        }
        
        // Take final screenshot
        await page.screenshot({ 
            path: 'test-results/happy-flow-final-page.png', 
            fullPage: true 
        });
        console.log('   üì∏ Final screenshot saved: happy-flow-final-page.png');
    });
});
